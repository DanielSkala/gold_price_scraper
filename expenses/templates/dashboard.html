<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Analytics Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #4c63b6, #667eea, #764ba2, #5a67d8, #6366f1, #8b5cf6);
            background-size: 400% 400%;
            animation: gradientShift 30s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .view-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .view-btn.active,
        .view-btn:hover {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            backdrop-filter: blur(20px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:active {
            transform: translateY(-1px) scale(0.98);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.8rem;
            color: white;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 1rem;
            font-weight: 500;
        }

        .stat-trend {
            font-size: 0.9rem;
            margin-top: 10px;
            padding: 6px 12px;
            border-radius: 25px;
            font-weight: 600;
            display: inline-block;
        }

        .trend-up { background: #fed7d7; color: #e53e3e; }
        .trend-down { background: #c6f6d5; color: #38a169; }

        /* View Containers */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(30px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Long-term Overview */
        .overview-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Detailed Monthly View */
        .monthly-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .category-details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .small-chart-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            height: 250px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .small-chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        .small-chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Chart Container */
        .chart-container {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .chart-filters {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 10px 18px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 25px;
            background: rgba(255,255,255,0.8);
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-btn.active,
        .filter-btn:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Side Panel for Category Details */
        .side-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            box-shadow: -10px 0 30px rgba(0,0,0,0.1);
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            overflow-y: auto;
        }

        .side-panel.open {
            right: 0;
        }

        .side-panel-header {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-panel {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .close-panel:hover {
            transform: rotate(90deg);
        }

        .side-panel-content {
            padding: 25px;
        }

        .category-summary {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .transaction-item {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .transaction-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateX(5px);
        }

        /* Transactions Section */
        .transactions-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
        }

        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .search-box {
            padding: 12px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            width: 300px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .transaction-table th,
        .transaction-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .transaction-table th {
            background: #f7fafc;
            font-weight: 700;
            color: #4a5568;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .transaction-table th:hover {
            background: #edf2f7;
        }

        .sort-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #718096;
        }

        .transaction-table tbody tr {
            transition: all 0.3s ease;
        }

        .transaction-table tbody tr:hover {
            background: #f0f4ff;
            transform: scale(1.01);
        }

        .category-badge {
            padding: 6px 14px;
            border-radius: 25px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: capitalize;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .category-badge:hover {
            transform: scale(1.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
        }

        .loading i {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: spin 1s linear infinite;
            color: white;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Category colors */
        .groceries { background: #e6fffa; color: #00695c; }
        .eating-out { background: #fff3e0; color: #ef6c00; }
        .bolt { background: #f3e5f5; color: #7b1fa2; }
        .car-wash { background: #e8f5e8; color: #2e7d32; }
        .gas-stations { background: #fff8e1; color: #f57f17; }
        .parking { background: #e3f2fd; color: #1565c0; }
        .nabytok { background: #fce4ec; color: #c2185b; }
        .oil-partner { background: #f1f8e9; color: #689f38; }
        .other { background: #fafafa; color: #616161; }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .category-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .overview-grid,
            .monthly-grid {
                grid-template-columns: 1fr;
            }

            .category-details-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2.2rem;
            }

            .search-box {
                width: 100%;
            }

            .side-panel {
                width: 100vw;
                right: -100vw;
            }

            .view-toggle {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Pulse animations for interactivity */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse-on-click {
            animation: pulse 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>

    <div class="dashboard-container">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Expense Analytics Dashboard</h1>
            <p>Track and analyze your spending patterns with beautiful, interactive visualizations</p>
        </header>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" onclick="switchView('overview')">
                <i class="fas fa-chart-area"></i> Long-term Overview
            </button>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="view-btn" onclick="switchView('monthly')">
                    <i class="fas fa-calendar-day"></i> Monthly Details
                </button>
                <select id="monthSelector" style="
                    padding: 12px 24px 12px 16px;
                    border: 2px solid rgba(255,255,255,0.4);
                    border-radius: 25px;
                    background: rgba(255,255,255,0.95);
                    color: #667eea;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 1rem;
                    backdrop-filter: blur(20px);
                    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    appearance: none;
                    background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iIzY2N2VlYSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+');
                    background-repeat: no-repeat;
                    background-position: right 16px center;
                    background-size: 12px;
                    min-width: 200px;
                    display: none;
                " onchange="handleMonthChange()"
                   onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.2)';"
                   onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)';">
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be loaded dynamically -->
        </div>

        <!-- Long-term Overview -->
        <div class="view-container active" id="overviewView">
            <div class="overview-grid">
                <!-- Monthly Trends Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Long-term Spending Trends</h3>
                        <div class="chart-filters">
                            <button class="filter-btn active" onclick="toggleChart('line')">Line</button>
                            <button class="filter-btn" onclick="toggleChart('bar')">Bar</button>
                            <button class="filter-btn" onclick="toggleChart('area')">Area</button>
                        </div>
                    </div>
                    <div id="monthlyChart" style="height: 450px;"></div>
                </div>

                <!-- Category Distribution -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Category Distribution</h3>
                        <div class="chart-filters">
                            <button class="filter-btn active" onclick="toggleCategoryView('total')">Total</button>
                            <button class="filter-btn" onclick="toggleCategoryView('average')">Average</button>
                            <button class="filter-btn" onclick="toggleCategoryView('last_3')">Last 3 Months</button>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; color: #718096; text-align: center; margin-bottom: 10px;" id="categorySubtitle">Click slices to view details</div>
                    <div id="categoryChart" style="height: 380px;"></div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="transactions-section">
                <div class="transactions-header">
                    <h3 class="chart-title">Recent Transactions</h3>
                    <input type="text" class="search-box" id="searchBox" placeholder="ðŸ” Search transactions...">
                </div>
                <div id="transactionsTable">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading transactions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Month Detailed View -->
        <div class="view-container" id="monthlyView">
            <div class="monthly-grid">
                <!-- Current Month Overview -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title" id="currentMonthTitle">Monthly Overview</h3>
                    </div>
                    <div id="currentMonthChart" style="height: 350px;"></div>
                </div>

                <!-- Daily Spending -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3 class="chart-title">Daily Spending</h3>
                    </div>
                    <div id="dailySpendingChart" style="height: 350px;"></div>
                </div>
            </div>

            <!-- Category Summary -->
            <div class="chart-container" style="margin-bottom: 30px;">
                <div class="chart-header">
                    <h3 class="chart-title">Category Breakdown</h3>
                </div>
                <div id="categoryBreakdown" style="padding: 25px;">
                    <!-- Category summary will be loaded here -->
                </div>
            </div>

            <!-- Current Month Transactions -->
            <div class="transactions-section">
                <div class="transactions-header">
                    <h3 class="chart-title" id="monthlyTransactionsTitle">This Month's Transactions</h3>
                    <input type="text" class="search-box" id="monthlySearchBox" placeholder="ðŸ” Search this month's transactions...">
                </div>
                <div id="monthlyTransactionsTable">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading transactions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Side Panel for Category Details -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <h3 id="sidePanelTitle">Category Details</h3>
                <button class="close-panel" onclick="closeSidePanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="side-panel-content" id="sidePanelContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        let currentView = 'overview';
        let currentChartType = 'line';
        let currentCategoryView = 'total'; // 'total', 'average', or 'last_3'
        let monthlyData = null;
        let categoryTotals = null;
        let categoryAverages = null;
        let transactions = null;
        let trends = null;
        let currentMonthDetails = null;
        let selectedMonth = null;
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let transactionsDisplayed = 50; // Start with 50 transactions
        let currentFilteredTransactions = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        function loadAllData() {
            Promise.all([
                fetch('/api/monthly-data').then(r => r.json()),
                fetch('/api/category-totals').then(r => r.json()),
                fetch('/api/category-averages').then(r => r.json()),
                fetch('/api/transactions').then(r => r.json()),
                fetch('/api/trends').then(r => r.json()),
                fetch('/api/current-month-details').then(r => r.json())
            ]).then(([monthly, totals, averages, trans, trendData, monthlyDetails]) => {
                monthlyData = monthly;
                categoryTotals = totals;
                categoryAverages = averages;
                transactions = trans;
                trends = trendData;
                currentMonthDetails = monthlyDetails;
                selectedMonth = monthlyDetails.month;

                renderStats();
                renderOverviewCharts();
                renderMonthlyDetailCharts();
                setupMonthSelector();
                renderTransactionsTable(); // Moved to last to ensure all data is ready
            }).catch(error => {
                console.error('Error loading data:', error);
            });
        }

        function setupMonthSelector() {
            if (!currentMonthDetails.available_months) return;

            const selector = document.getElementById('monthSelector');
            selector.innerHTML = currentMonthDetails.available_months.map(month => `
                <option value="${month}" ${month === selectedMonth ? 'selected' : ''}>
                    ${new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </option>
            `).join('');

            selector.addEventListener('change', function(e) {
                selectedMonth = e.target.value;
                loadMonthDetails(selectedMonth);
            });
        }

        function loadMonthDetails(month) {
            fetch(`/api/current-month-details/${month}`)
                .then(r => r.json())
                .then(data => {
                    currentMonthDetails = data;
                    selectedMonth = month;
                    renderStats();
                    renderMonthlyDetailCharts();
                })
                .catch(error => {
                    console.error('Error loading month details:', error);
                });
        }

        function switchView(view) {
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('pulse-on-click');
                setTimeout(() => btn.classList.remove('pulse-on-click'), 300);
            });
            event.target.classList.add('active');

            // Show/hide month selector
            const monthSelector = document.getElementById('monthSelector');
            if (view === 'monthly') {
                monthSelector.style.display = 'block';
            } else {
                monthSelector.style.display = 'none';
            }

            // Hide all views
            document.querySelectorAll('.view-container').forEach(container => {
                container.classList.remove('active');
            });

            // Show selected view
            document.getElementById(view + 'View').classList.add('active');
            currentView = view;

            // Reset transaction display count when switching views
            transactionsDisplayed = 50;

            // Re-render stats for the new view
            renderStats();

            // Trigger resize for charts
            setTimeout(() => {
                if (view === 'overview') {
                    Plotly.Plots.resize('monthlyChart');
                    Plotly.Plots.resize('categoryChart');
                } else {
                    Plotly.Plots.resize('currentMonthChart');
                    Plotly.Plots.resize('dailySpendingChart');
                }
            }, 100);
        }

        function handleMonthChange() {
            const selector = document.getElementById('monthSelector');
            selectedMonth = selector.value;
            loadMonthDetails(selectedMonth);
        }

        function renderStats() {
            const statsGrid = document.getElementById('statsGrid');

            if (currentView === 'overview') {
                // Overview stats - long-term metrics
                const totalSpending = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
                const topCategory = Object.entries(categoryTotals)
                    .reduce((a, b) => categoryTotals[a[0]] > categoryTotals[b[0]] ? a : b);
                const avgMonthly = monthlyData.totals.reduce((a, b) => a + b, 0) / monthlyData.totals.length;
                const recentTrend = monthlyData.totals.length > 1 ?
                    ((monthlyData.totals[monthlyData.totals.length - 1] - monthlyData.totals[monthlyData.totals.length - 2]) / monthlyData.totals[monthlyData.totals.length - 2] * 100) : 0;

                const stats = [
                    {
                        icon: 'fas fa-euro-sign',
                        iconBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        value: `â‚¬${totalSpending.toFixed(2)}`,
                        label: 'Total Spending'
                    },
                    {
                        icon: 'fas fa-chart-bar',
                        iconBg: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
                        value: `â‚¬${avgMonthly.toFixed(2)}`,
                        label: 'Avg Monthly',
                        trend: recentTrend
                    },
                    {
                        icon: 'fas fa-crown',
                        iconBg: 'linear-gradient(135deg, #4c63b6 0%, #5a67d8 100%)',
                        value: topCategory[0].replace('_', ' ').replace('-', ' '),
                        label: 'Top Category',
                        subValue: `â‚¬${topCategory[1].toFixed(2)}`
                    },
                    {
                        icon: 'fas fa-calendar-alt',
                        iconBg: 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)',
                        value: monthlyData.months.length,
                        label: 'Months Tracked'
                    }
                ];

                statsGrid.innerHTML = stats.map(stat => createStatCard(stat)).join('');
            } else {
                // Monthly stats - current month specific
                if (!currentMonthDetails) return;

                const monthTotal = Object.values(currentMonthDetails.category_totals).reduce((a, b) => a + b, 0);
                const topMonthCategory = Object.entries(currentMonthDetails.category_totals)
                    .filter(([_, val]) => val > 0)
                    .reduce((a, b) => a[1] > b[1] ? a : b, ['other', 0]);
                const avgDaily = monthTotal / Object.keys(currentMonthDetails.daily_spending).length;
                const totalTxs = currentMonthDetails.total_transactions;

                const stats = [
                    {
                        icon: 'fas fa-euro-sign',
                        iconBg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        value: `â‚¬${monthTotal.toFixed(2)}`,
                        label: 'This Month Total'
                    },
                    {
                        icon: 'fas fa-calendar-day',
                        iconBg: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
                        value: `â‚¬${avgDaily.toFixed(2)}`,
                        label: 'Avg Per Day'
                    },
                    {
                        icon: 'fas fa-star',
                        iconBg: 'linear-gradient(135deg, #4c63b6 0%, #5a67d8 100%)',
                        value: topMonthCategory[0].replace('_', ' ').replace('-', ' '),
                        label: 'Top This Month',
                        subValue: `â‚¬${topMonthCategory[1].toFixed(2)}`
                    },
                    {
                        icon: 'fas fa-receipt',
                        iconBg: 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)',
                        value: totalTxs,
                        label: 'Transactions'
                    }
                ];

                statsGrid.innerHTML = stats.map(stat => createStatCard(stat)).join('');
            }
        }

        function createStatCard(stat) {
            return `
                <div class="stat-card">
                    <div class="stat-icon" style="background: ${stat.iconBg}">
                        <i class="${stat.icon}"></i>
                    </div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                    ${stat.subValue ? `<div style="font-size: 0.9rem; color: #718096; margin-top: 5px;">${stat.subValue}</div>` : ''}
                    ${stat.trend !== undefined && stat.trend !== null ? `
                        <div class="stat-trend ${stat.trend >= 0 ? 'trend-up' : 'trend-down'}">
                            <i class="fas fa-arrow-${stat.trend >= 0 ? 'up' : 'down'}"></i>
                            ${Math.abs(stat.trend).toFixed(1)}%
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderOverviewCharts() {
            renderMonthlyChart();
            renderCategoryChart();
        }

        function renderMonthlyChart() {
            const traces = [];

            // Add total spending line
            traces.push({
                x: monthlyData.months,
                y: monthlyData.totals,
                type: currentChartType === 'area' ? 'scatter' : currentChartType,
                mode: currentChartType === 'line' ? 'lines+markers' : undefined,
                fill: currentChartType === 'area' ? 'tonexty' : undefined,
                name: 'Total',
                line: { color: '#2d3748', width: 4 },
                marker: { size: 10, color: '#2d3748' }
            });

            // Add ALL categories
            const allCategories = Object.entries(monthlyData.categories)
                .sort((a, b) => {
                    const sumA = a[1].reduce((sum, val) => sum + val, 0);
                    const sumB = b[1].reduce((sum, val) => sum + val, 0);
                    return sumB - sumA;
                });

            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#ff6b6b', '#4ecdc4',
                '#45b7d1', '#f9ca24', '#6c5ce7', '#a29bfe', '#fd79a8'
            ];

            allCategories.forEach(([category, values], index) => {
                traces.push({
                    x: monthlyData.months,
                    y: values,
                    type: currentChartType === 'area' ? 'scatter' : currentChartType,
                    mode: currentChartType === 'line' ? 'lines+markers' : undefined,
                    fill: currentChartType === 'area' ? 'tonexty' : undefined,
                    name: category.replace('_', ' ').replace('-', ' '),
                    line: { color: colors[index % colors.length], width: 2 },
                    marker: { size: 6, color: colors[index % colors.length] }
                });
            });

            const layout = {
                title: '',
                xaxis: {
                    title: 'Month',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    titlefont: { size: 14, color: '#4a5568' }
                },
                yaxis: {
                    title: 'Amount (â‚¬)',
                    showgrid: true,
                    gridcolor: '#f0f0f0',
                    titlefont: { size: 14, color: '#4a5568' }
                },
                plot_bgcolor: 'rgba(255,255,255,0.8)',
                paper_bgcolor: 'rgba(255,255,255,0)',
                font: { family: 'Inter, sans-serif', color: '#2d3748' },
                margin: { t: 20, r: 20, b: 60, l: 70 },
                hovermode: 'x unified',
                legend: {
                    orientation: 'h',
                    y: -0.2,
                    x: 0.5,
                    xanchor: 'center'
                }
            };

            Plotly.newPlot('monthlyChart', traces, layout, {
                responsive: true,
                displayModeBar: false,
                showTips: false
            });
        }

        function renderCategoryChart() {
            // Determine which data to use based on current view
            let dataToUse;
            let subtitleText;
            let centerText;

            if (currentCategoryView === 'total') {
                dataToUse = categoryTotals;
                subtitleText = 'Total spending across all time';
                centerText = `â‚¬${Object.values(categoryTotals).reduce((a, b) => a + b, 0).toFixed(0)}<br><span style="font-size:14px;">Total</span>`;
            } else if (currentCategoryView === 'average') {
                dataToUse = categoryAverages.overall;
                subtitleText = `Average per month (${categoryAverages.num_months} months)`;
                centerText = `â‚¬${Object.values(categoryAverages.overall).reduce((a, b) => a + b, 0).toFixed(0)}<br><span style="font-size:14px;">Avg/Month</span>`;
            } else { // last_3
                dataToUse = categoryAverages.last_3_months;
                subtitleText = `Average of last ${categoryAverages.last_3_count} months`;
                centerText = `â‚¬${Object.values(categoryAverages.last_3_months).reduce((a, b) => a + b, 0).toFixed(0)}<br><span style="font-size:14px;">Avg/Month</span>`;
            }

            // Update subtitle
            document.getElementById('categorySubtitle').textContent = subtitleText;

            const sortedCategories = Object.entries(dataToUse)
                .filter(([_, val]) => val > 0)
                .sort((a, b) => b[1] - a[1]);

            const trace = {
                labels: sortedCategories.map(([cat, _]) => cat.replace('_', ' ').replace('-', ' ')),
                values: sortedCategories.map(([_, val]) => val),
                type: 'pie',
                hole: 0.5,
                marker: {
                    colors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#ff6b6b', '#4ecdc4'].slice(0, sortedCategories.length),
                    line: { color: '#ffffff', width: 3 }
                },
                textinfo: 'label+percent',
                textposition: 'outside',
                textfont: { size: 11, color: '#2d3748' },
                hovertemplate: '<b>%{label}</b><br>â‚¬%{value:.2f}<br>%{percent}<br><i>Click to view details</i><extra></extra>',
                hoverlabel: { bgcolor: 'rgba(255,255,255,0.9)', bordercolor: '#667eea' }
            };

            const layout = {
                title: '',
                font: { family: 'Inter, sans-serif', color: '#2d3748' },
                margin: { t: 10, r: 10, b: 10, l: 10 },
                showlegend: false,
                plot_bgcolor: 'rgba(255,255,255,0)',
                paper_bgcolor: 'rgba(255,255,255,0)',
                annotations: [{
                    text: centerText,
                    x: 0.5, y: 0.5,
                    font: { size: 20, color: '#2d3748' },
                    showarrow: false
                }]
            };

            Plotly.newPlot('categoryChart', [trace], layout, {
                responsive: true,
                displayModeBar: false,
                showTips: false
            });

            // Add click handler for pie chart
            document.getElementById('categoryChart').on('plotly_click', function(data) {
                const point = data.points[0];
                const category = sortedCategories[point.pointNumber][0];
                showCategoryDetails(category);
            });
        }

        function toggleCategoryView(view) {
            currentCategoryView = view;

            // Update button states
            const buttons = document.querySelectorAll('.chart-container .chart-filters .filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('pulse-on-click');
                setTimeout(() => btn.classList.remove('pulse-on-click'), 300);
            });
            event.target.classList.add('active');

            // Re-render the chart
            renderCategoryChart();
        }

        function renderMonthlyDetailCharts() {
            if (!currentMonthDetails || !currentMonthDetails.month) return;

            // Update month title
            document.getElementById('currentMonthTitle').textContent =
                `${new Date(currentMonthDetails.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} Overview`;

            // Update transactions title
            document.getElementById('monthlyTransactionsTitle').textContent =
                `${new Date(currentMonthDetails.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })} Transactions`;

            // Current month pie chart
            const monthCategories = Object.entries(currentMonthDetails.category_totals)
                .filter(([_, val]) => val > 0)
                .sort((a, b) => b[1] - a[1]);

            if (monthCategories.length > 0) {
                const trace = {
                    labels: monthCategories.map(([cat, _]) => cat.replace('_', ' ').replace('-', ' ')),
                    values: monthCategories.map(([_, val]) => val),
                    type: 'pie',
                    hole: 0.4,
                    marker: {
                        colors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#ff6b6b', '#4ecdc4'].slice(0, monthCategories.length),
                        line: { color: '#ffffff', width: 2 }
                    },
                    textinfo: 'label+value',
                    texttemplate: '%{label}<br>â‚¬%{value:.0f}',
                    textposition: 'outside',
                    textfont: { size: 11 },
                    hovertemplate: '<b>%{label}</b><br>â‚¬%{value:.2f}<br>%{percent}<br><i>Click to view details</i><extra></extra>'
                };

                const layout = {
                    margin: { t: 20, r: 20, b: 20, l: 20 },
                    showlegend: false,
                    plot_bgcolor: 'rgba(255,255,255,0)',
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    font: { family: 'Inter, sans-serif', color: '#2d3748' }
                };

                Plotly.newPlot('currentMonthChart', [trace], layout, {
                    responsive: true,
                    displayModeBar: false
                });

                // Add click handler for current month pie chart
                document.getElementById('currentMonthChart').on('plotly_click', function(data) {
                    const point = data.points[0];
                    const category = monthCategories[point.pointNumber][0];
                    showCategoryDetails(category);
                });
            }

            // Daily spending chart
            const dailyData = Object.entries(currentMonthDetails.daily_spending)
                .sort((a, b) => a[0].localeCompare(b[0]));

            if (dailyData.length > 0) {
                const trace = {
                    x: dailyData.map(([date, _]) => date),
                    y: dailyData.map(([_, amount]) => amount),
                    type: 'bar',
                    marker: {
                        color: dailyData.map(([_, amount]) => amount),
                        colorscale: [[0, '#e3f2fd'], [1, '#1565c0']],
                        showscale: false
                    },
                    hovertemplate: '<b>%{x}</b><br>â‚¬%{y:.2f}<extra></extra>'
                };

                const layout = {
                    margin: { t: 20, r: 20, b: 60, l: 50 },
                    xaxis: {
                        title: 'Date',
                        titlefont: { size: 12 }
                    },
                    yaxis: {
                        title: 'Amount (â‚¬)',
                        titlefont: { size: 12 }
                    },
                    plot_bgcolor: 'rgba(255,255,255,0.8)',
                    paper_bgcolor: 'rgba(255,255,255,0)',
                    font: { family: 'Inter, sans-serif', color: '#2d3748' }
                };

                Plotly.newPlot('dailySpendingChart', [trace], layout, {
                    responsive: true,
                    displayModeBar: false
                });
            }

            // Create category breakdown
            renderCategoryBreakdown();

            // Render current month transactions
            renderMonthlyTransactionsTable();
        }

        function renderCategoryBreakdown() {
            if (!currentMonthDetails) return;

            const container = document.getElementById('categoryBreakdown');
            const categoryData = Object.entries(currentMonthDetails.category_totals)
                .filter(([_, amount]) => amount > 0)
                .sort((a, b) => b[1] - a[1]);

            const totalAmount = categoryData.reduce((sum, [_, amount]) => sum + amount, 0);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    ${categoryData.map(([category, amount]) => {
                        const percentage = ((amount / totalAmount) * 100).toFixed(1);
                        const txCount = currentMonthDetails.category_transactions[category]?.length || 0;

                        return `
                            <div style="
                                background: rgba(102, 126, 234, 0.1);
                                border-left: 4px solid #667eea;
                                padding: 20px;
                                border-radius: 10px;
                                cursor: pointer;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(102, 126, 234, 0.15)'"
                               onmouseout="this.style.background='rgba(102, 126, 234, 0.1)'"
                               onclick="showCategoryDetails('${category}')">
                                <div style="font-weight: 700; font-size: 1.1rem; color: #2d3748; margin-bottom: 8px; text-transform: capitalize;">
                                    ${category.replace('_', ' ').replace('-', ' ')}
                                </div>
                                <div style="font-size: 1.8rem; font-weight: 700; color: #667eea; margin-bottom: 5px;">
                                    â‚¬${amount.toFixed(2)}
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #718096;">
                                    <span>${percentage}% of total</span>
                                    <span>${txCount} transactions</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 10px;">
                    <div style="font-weight: 600; color: #2d3748;">Monthly Total: â‚¬${totalAmount.toFixed(2)}</div>
                </div>
            `;
        }

        let currentCategoryData = null;
        let currentTransactionPage = 0;
        const transactionsPerPage = 15;

        function showCategoryDetails(category) {
            // Use different API endpoint based on current view
            let apiEndpoint;
            if (currentView === 'monthly') {
                apiEndpoint = selectedMonth
                    ? `/api/current-month-category-transactions/${category}/${selectedMonth}`
                    : `/api/current-month-category-transactions/${category}`;
            } else {
                apiEndpoint = `/api/category-transactions/${category}`;
            }

            fetch(apiEndpoint)
                .then(response => response.json())
                .then(data => {
                    currentCategoryData = data;
                    currentTransactionPage = 0;
                    renderCategoryPanel();
                })
                .catch(error => {
                    console.error('Error loading category details:', error);
                });
        }

        function renderCategoryPanel() {
            if (!currentCategoryData) return;

            const panel = document.getElementById('sidePanel');
            const title = document.getElementById('sidePanelTitle');
            const content = document.getElementById('sidePanelContent');

            title.innerHTML = `<i class="fas fa-tag"></i> ${currentCategoryData.category.replace('_', ' ').replace('-', ' ')}`;

            const startIdx = currentTransactionPage * transactionsPerPage;
            const endIdx = startIdx + transactionsPerPage;
            const transactionsToShow = currentCategoryData.transactions.slice(startIdx, endIdx);
            const hasMore = endIdx < currentCategoryData.transactions.length;
            const hasPrev = currentTransactionPage > 0;

            content.innerHTML = `
                <div class="category-summary">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-weight: 600;">Total Amount:</span>
                        <span style="font-size: 1.2rem; font-weight: 700; color: #667eea;">â‚¬${currentCategoryData.total_amount.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600;">Transactions:</span>
                        <span style="color: #718096;">${currentCategoryData.transaction_count}</span>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #2d3748; margin: 0;">All Transactions</h4>
                    <div style="font-size: 0.9rem; color: #718096;">
                        ${startIdx + 1}-${Math.min(endIdx, currentCategoryData.transactions.length)} of ${currentCategoryData.transactions.length}
                    </div>
                </div>
                ${transactionsToShow.map(tx => `
                    <div class="transaction-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 5px;">${tx.merchant}</div>
                                <div style="font-size: 0.9rem; color: #718096;">${new Date(tx.date).toLocaleDateString()}</div>
                            </div>
                            <div style="font-weight: 700; color: #e53e3e;">â‚¬${tx.amount.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('')}
                ${(hasMore || hasPrev) ? `
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding: 15px;">
                        ${hasPrev ? `
                            <button onclick="loadPreviousTransactions()" style="
                                padding: 8px 16px;
                                border: 2px solid #667eea;
                                border-radius: 20px;
                                background: white;
                                color: #667eea;
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            ">â† Previous</button>
                        ` : ''}
                        ${hasMore ? `
                            <button onclick="loadMoreTransactions()" style="
                                padding: 8px 16px;
                                border: 2px solid #667eea;
                                border-radius: 20px;
                                background: #667eea;
                                color: white;
                                cursor: pointer;
                                font-weight: 600;
                                transition: all 0.3s ease;
                            ">Next â†’</button>
                        ` : ''}
                    </div>
                ` : ''}
            `;

            panel.classList.add('open');
        }

        function loadMoreTransactions() {
            currentTransactionPage++;
            renderCategoryPanel();
        }

        function loadPreviousTransactions() {
            currentTransactionPage = Math.max(0, currentTransactionPage - 1);
            renderCategoryPanel();
        }

        function closeSidePanel() {
            document.getElementById('sidePanel').classList.remove('open');
        }

        function sortTransactions(data, column, direction) {
            if (!data || !Array.isArray(data)) return [];
            return [...data].sort((a, b) => {
                let valueA, valueB;

                switch (column) {
                    case 'date':
                        valueA = new Date(a.date);
                        valueB = new Date(b.date);
                        break;
                    case 'amount':
                        valueA = a.amount;
                        valueB = b.amount;
                        break;
                    case 'merchant':
                        valueA = a.merchant.toLowerCase();
                        valueB = b.merchant.toLowerCase();
                        break;
                    case 'category':
                        valueA = a.category.toLowerCase();
                        valueB = b.category.toLowerCase();
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function handleSort(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }

            // Reset display count when sorting changes
            transactionsDisplayed = 50;

            renderTransactionsTable();
            if (currentView === 'monthly') {
                renderMonthlyTransactionsTable();
            }
        }

        function renderTransactionsTable(filteredTransactions = null) {
            // Safety check - don't render if data isn't loaded yet
            if (!transactions || !Array.isArray(transactions)) {
                document.getElementById('transactionsTable').innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading transactions...</p>
                    </div>
                `;
                return;
            }

            try {
                const baseData = filteredTransactions || transactions;
                const sortedData = sortTransactions(baseData, sortColumn, sortDirection);

                // Store current filtered data for "load more" functionality
                currentFilteredTransactions = sortedData;

                if (!sortedData || sortedData.length === 0) {
                    document.getElementById('transactionsTable').innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #718096;">
                            <p>No transactions to display</p>
                        </div>
                    `;
                    return;
                }

            // Show transactions up to the current display limit
            const transactionsToShow = sortedData.slice(0, transactionsDisplayed);
            const hasMoreTransactions = sortedData.length > transactionsDisplayed;

            const getSortArrow = (column) => {
                if (sortColumn !== column) return '';
                return sortDirection === 'asc' ? 'â†‘' : 'â†“';
            };

            const tableHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="color: #718096; font-size: 0.9rem;">
                        Showing ${transactionsToShow.length} of ${sortedData.length} transactions
                    </div>
                </div>
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th onclick="handleSort('date')">
                                Date <span class="sort-arrow">${getSortArrow('date')}</span>
                            </th>
                            <th onclick="handleSort('merchant')">
                                Merchant <span class="sort-arrow">${getSortArrow('merchant')}</span>
                            </th>
                            <th onclick="handleSort('category')">
                                Category <span class="sort-arrow">${getSortArrow('category')}</span>
                            </th>
                            <th onclick="handleSort('amount')">
                                Amount <span class="sort-arrow">${getSortArrow('amount')}</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactionsToShow.map(tx => `
                            <tr onclick="this.classList.add('pulse-on-click'); setTimeout(() => this.classList.remove('pulse-on-click'), 300)">
                                <td>${new Date(tx.date).toLocaleDateString()}</td>
                                <td style="font-weight: 500;">${tx.merchant}</td>
                                <td>
                                    <span class="category-badge ${tx.category.replace(' ', '-').replace('_', '-')}"
                                          onclick="event.stopPropagation(); showCategoryDetails('${tx.category}')">
                                        ${tx.category.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style="font-weight: 700; color: #e53e3e;">â‚¬${tx.amount.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${hasMoreTransactions ? `
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="loadMoreTransactions()" style="
                            padding: 12px 24px;
                            border: 2px solid #667eea;
                            border-radius: 25px;
                            background: white;
                            color: #667eea;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1rem;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#667eea'; this.style.color='white';"
                           onmouseout="this.style.background='white'; this.style.color='#667eea';">
                            <i class="fas fa-plus"></i> Load More Transactions
                        </button>
                    </div>
                ` : ''}
            `;

            document.getElementById('transactionsTable').innerHTML = tableHTML;
            } catch (error) {
                console.error('Error rendering transactions table:', error);
                document.getElementById('transactionsTable').innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #e53e3e;">
                        <p>Error loading transactions. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function loadMoreTransactions() {
            // Increase the number of displayed transactions by 50
            transactionsDisplayed += 50;

            // Re-render the table with current filtered data
            if (currentFilteredTransactions) {
                renderTransactionsTable(currentFilteredTransactions === transactions ? null : currentFilteredTransactions);
            } else {
                renderTransactionsTable();
            }
        }

        function toggleChart(type) {
            currentChartType = type;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('pulse-on-click');
                setTimeout(() => btn.classList.remove('pulse-on-click'), 300);
            });
            event.target.classList.add('active');

            renderMonthlyChart();
        }

        function renderMonthlyTransactionsTable(filteredTransactions = null) {
            if (!currentMonthDetails) return;

            // Get all transactions for current month
            let monthlyTransactions = Object.values(currentMonthDetails.category_transactions)
                .flat();

            let transactionsToShow = filteredTransactions || monthlyTransactions;
            transactionsToShow = sortTransactions(transactionsToShow, sortColumn, sortDirection);

            const getSortArrow = (column) => {
                if (sortColumn !== column) return '';
                return sortDirection === 'asc' ? 'â†‘' : 'â†“';
            };

            const tableHTML = `
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th onclick="handleSort('date')">
                                Date <span class="sort-arrow">${getSortArrow('date')}</span>
                            </th>
                            <th onclick="handleSort('merchant')">
                                Merchant <span class="sort-arrow">${getSortArrow('merchant')}</span>
                            </th>
                            <th onclick="handleSort('category')">
                                Category <span class="sort-arrow">${getSortArrow('category')}</span>
                            </th>
                            <th onclick="handleSort('amount')">
                                Amount <span class="sort-arrow">${getSortArrow('amount')}</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactionsToShow.map(tx => `
                            <tr>
                                <td>${new Date(tx.date).toLocaleDateString()}</td>
                                <td style="font-weight: 500;">${tx.merchant}</td>
                                <td>
                                    <span class="category-badge ${tx.category.replace(' ', '-').replace('_', '-')}"
                                          onclick="showCategoryDetails('${tx.category}')">
                                        ${tx.category.replace('_', ' ')}
                                    </span>
                                </td>
                                <td style="font-weight: 700; color: #e53e3e;">â‚¬${tx.amount.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div style="text-align: center; padding: 20px; color: #718096;">
                    Showing ${transactionsToShow.length} transactions for ${new Date(currentMonthDetails.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </div>
            `;

            document.getElementById('monthlyTransactionsTable').innerHTML = tableHTML;
        }

        // Search functionality for overview
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();

            // Reset display count when searching
            transactionsDisplayed = 50;

            if (!searchTerm) {
                renderTransactionsTable();
                return;
            }

            const filtered = transactions.filter(tx =>
                tx.merchant.toLowerCase().includes(searchTerm) ||
                tx.category.toLowerCase().includes(searchTerm)
            );

            renderTransactionsTable(filtered);
        });

        // Search functionality for monthly view
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const monthlySearchBox = document.getElementById('monthlySearchBox');
                if (monthlySearchBox) {
                    monthlySearchBox.addEventListener('input', function(e) {
                        if (!currentMonthDetails) return;

                        const searchTerm = e.target.value.toLowerCase();
                        const allMonthlyTransactions = Object.values(currentMonthDetails.category_transactions)
                            .flat()
                            .sort((a, b) => new Date(b.date) - new Date(a.date));

                        if (!searchTerm) {
                            renderMonthlyTransactionsTable();
                            return;
                        }

                        const filtered = allMonthlyTransactions.filter(tx =>
                            tx.merchant.toLowerCase().includes(searchTerm) ||
                            tx.category.toLowerCase().includes(searchTerm)
                        );

                        renderMonthlyTransactionsTable(filtered);
                    });
                }
            }, 500);
        });

        // Close side panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('sidePanel');
            if (panel.classList.contains('open') && !panel.contains(e.target) && !e.target.closest('[data-category-click]')) {
                closeSidePanel();
            }
        });

        // Add escape key handler for side panel
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSidePanel();
            }
        });
    </script>
</body>
</html>